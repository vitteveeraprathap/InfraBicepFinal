name: Deploy Infra (subscription-level)

on:
  workflow_dispatch:
    inputs:
      target:
        description: 'Which resource to deploy'
        required: true
        type: choice
        options:
          - all
          - resource-group
          - storage
          - keyvault
          - container
        default: all
      environment:
        description: 'Environment (dev/uat/prod) - fallback only'
        required: false
        type: choice
        options:
          - dev
          - uat
          - prod
        default: dev
      location:
        description: 'Azure location (overrides param file if provided)'
        required: false
        default: ''

jobs:
  deploy:
    runs-on: ubuntu-latest

    # Map branch/ref -> environment (feature/* -> dev, develop -> uat, master -> prod).
    # If none of those match, fall back to the workflow_dispatch input.
    environment: ${{ 
      startsWith(github.ref, 'refs/heads/feature/') && 'dev' ||
      github.ref == 'refs/heads/develop' && 'uat' ||
      github.ref == 'refs/heads/master' && 'prod' ||
      github.event.inputs.environment
    }}

    env:
      BICEP_MAIN: infra/main.bicep
      # Use same mapping for params file path
      PARAMS_FILE: infra/parameters/${
        {{
          startsWith(github.ref, 'refs/heads/feature/') && 'dev' ||
          github.ref == 'refs/heads/develop' && 'uat' ||
          github.ref == 'refs/heads/master' && 'prod' ||
          github.event.inputs.environment
        }}
      }.parameters.json

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Show chosen ref & environment
        run: |
          echo "github.ref = $GITHUB_REF"
          echo "Computed ENV = ${{ job.environment.name }}"

      - name: Azure login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Ensure Azure CLI & Bicep
        run: |
          sudo apt-get update -y
          sudo apt-get install -y ca-certificates curl apt-transport-https lsb-release gnupg
          curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
          az version
          az bicep install || true
          az bicep upgrade || true
          az bicep version

      - name: Resolve target flags
        id: flags
        run: |
          tgt="${{ github.event.inputs.target }}"
          case "$tgt" in
            all)
              echo "deployStorage=true" >> $GITHUB_OUTPUT
              echo "deployKeyVault=true" >> $GITHUB_OUTPUT
              echo "deployContainer=true" >> $GITHUB_OUTPUT
              ;;
            resource-group)
              echo "deployStorage=false" >> $GITHUB_OUTPUT
              echo "deployKeyVault=false" >> $GITHUB_OUTPUT
              echo "deployContainer=false" >> $GITHUB_OUTPUT
              ;;
            storage)
              echo "deployStorage=true" >> $GITHUB_OUTPUT
              echo "deployKeyVault=false" >> $GITHUB_OUTPUT
              echo "deployContainer=false" >> $GITHUB_OUTPUT
              ;;
            keyvault)
              echo "deployStorage=false" >> $GITHUB_OUTPUT
              echo "deployKeyVault=true" >> $GITHUB_OUTPUT
              echo "deployContainer=false" >> $GITHUB_OUTPUT
              ;;
            container)
              echo "deployStorage=false" >> $GITHUB_OUTPUT
              echo "deployKeyVault=false" >> $GITHUB_OUTPUT
              echo "deployContainer=true" >> $GITHUB_OUTPUT
              ;;
            *)
              echo "Unknown target" >&2
              exit 1
              ;;
          esac

      - name: What-if (preview changes)
        run: |
          CHOSEN_ENV=$(
            echo "${{ github.ref }}" | awk '
              /refs\/heads\/feature\// { print "dev"; exit }
              /refs\/heads\/develop$/ { print "uat"; exit }
              /refs\/heads\/master$/ { print "prod"; exit }
              { print "'"${{ github.event.inputs.environment }}"'" }
            '
          )
          echo "Using params for env: $CHOSEN_ENV"
          LOCATION="${{ github.event.inputs.location }}"
          if [ -z "$LOCATION" ]; then LOCATION="southeastasia"; fi

          az deployment sub what-if \
            --location "$LOCATION" \
            --template-file "${{ env.BICEP_MAIN }}" \
            --parameters @"infra/parameters/${CHOSEN_ENV}.parameters.json" \
            deployStorage=${{ steps.flags.outputs.deployStorage }} \
            deployKeyVault=${{ steps.flags.outputs.deployKeyVault }} \
            deployContainer=${{ steps.flags.outputs.deployContainer }} \
            --query "properties.changeSummary" --output json

      - name: Deploy (subscription-level)
        run: |
          CHOSEN_ENV=$(
            echo "${{ github.ref }}" | awk '
              /refs\/heads\/feature\// { print "dev"; exit }
              /refs\/heads\/develop$/ { print "uat"; exit }
              /refs\/heads\/master$/ { print "prod"; exit }
              { print "'"${{ github.event.inputs.environment }}"'" }
            '
          )
          echo "Using params for env: $CHOSEN_ENV"
          LOCATION="${{ github.event.inputs.location }}"
          if [ -z "$LOCATION" ]; then LOCATION="southeastasia"; fi
          DEPLOY_NAME="sub-deploy-${{ github.run_id }}"

          az deployment sub create \
            --name "$DEPLOY_NAME" \
            --location "$LOCATION" \
            --template-file "${{ env.BICEP_MAIN }}" \
            --parameters @"infra/parameters/${CHOSEN_ENV}.parameters.json" \
            deployStorage=${{ steps.flags.outputs.deployStorage }} \
            deployKeyVault=${{ steps.flags.outputs.deployKeyVault }} \
            deployContainer=${{ steps.flags.outputs.deployContainer }} \
            --only-show-errors
